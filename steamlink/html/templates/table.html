<div class="{{ partial_item.grid_columns }} columns">
    <style>
        .table-partial > table > thead > tr, tbody {
            /* display:block; */
        }
        .table-partial > table > tbody > tr:hover { 
            background: #F7F7F5;
            cursor: pointer;
        }
    </style>
    <h4 class="table-partial partial-heading">
        {{ partial_item.title }}
    </h4>
    <div class="table-partial partial" id="{{ partial_item.name }}" 
        {% if partial_item.grid_rows %}
        style="height:{{ partial_item.grid_rows * 50}}px; overflow:scroll;"
        {% endif %}
    >
        <table>
            <thead>
                {% for header in partial_item.headers %}
                <th>{{ header }}</th>
                {% endfor %}
            </thead>
            <tbody >
            </tbody>
        </table>
        <button id="{{ partial_item.name }}_first">&lt;&lt;</button>
        <button id="{{ partial_item.name }}_prev">&lt;</button>
        <button id="{{ partial_item.name }}_next">&gt;</button>
        <button id="{{ partial_item.name }}_last">&gt;&gt;</button>
        <button id="{{ partial_item.name }}_sort_order">Toggle Sort Order</button>

    </div>
</div>

<script type="text/javascript">
    $(function () {

        var scrolledDiv = $('#{{ partial_item.name }} > table > tbody')[0];
        var nextButton = $('#{{ partial_item.name }}_next')[0];
        var prevButton = $('#{{ partial_item.name }}_prev')[0];
        var firstButton = $('#{{ partial_item.name }}_first'[0]);
        var lastButton = $('#{{ partial_item.name }}_last')[0];
        var sortButton = $('#{{ partial_item.name }}_sort_order')[0];

        var headers = {{ partial_item.headers|tojson|safe }};

        var sortMultiplier = 1;

        var startStreamConfig = {
            table_name: {{ partial_item.table_name|tojson|safe }},
            key_field: {{ partial_item.key_field|tojson|safe }},
            restrict_by: {{ partial_item.restrict_by|tojson|safe }},
            start_key: {{ partial_item.start_key|tojson|safe }},
            start_item_number: {{ partial_item.start_item_number|tojson|safe }},
            count: {{ partial_item.count|tojson|safe }},
            end_key: {{ partial_item.end_key|tojson|safe }},
            stream_tag: {{ partial_item.stream_tag|tojson|safe }}
        };

        var record_link = "{{ partial_item.record_link }}";
        var table_rows = {{ partial_item.table_rows|tojson|safe }};



        var renderTable = function() {
            var htmlString = "";
            var cache = tableStream.cache.sort(function(a,b) {
                return sortMultiplier*(a[tableStream.config.key_field] - b[tableStream.config.key_field]);
            })            
            cache.forEach((item) => {
                htmlString += "<tr>";
                headers.forEach( (header) => {
                    if(header in item) {
                        htmlString += "<td>" + "<a href =" + window.format(record_link, {"key" : item[tableStream.config.key_field] }) + ">" + item[header] + "</a></td>";
                    } else {
                        htmlString += "<td></td>";   
                    }
                });
                htmlString += "</tr>";
                scrolledDiv.innerHTML = htmlString;
            });
        }

        var onNewMessage = function(data) {
            renderTable();
        }
        
        nextButton.onclick = function() {
            var newConfig = tableStream.config;
            if ((newConfig.start_item_number + newConfig.count - 1) < newConfig.total_item_count) {
                newConfig.start_key = null;
                newConfig.end_key = null;
                newConfig.start_item_number = newConfig.start_item_number + table_rows;
                newConfig.count = table_rows;
                tableStream.updateStream(newConfig);
            }            
        };

        prevButton.onclick = function() {
            var newConfig = tableStream.config;
            if (newConfig.start_item_number > 0) {
                newConfig.start_key = null;
                newConfig.end_key = null;
                newConfig.start_item_number = newConfig.start_item_number - table_rows;
                newConfig.count = table_rows;
                tableStream.updateStream(newConfig);
            }            
        };

        firstButton.onclick = function() {
            var newConfig = tableStream.config;
            newConfig.start_key = null;
            newConfig.end_key = null;
            newConfig.start_item_number = 0;
            newConfig.count = table_rows;
            tableStream.updateStream(newConfig);
            
        };

        lastButton.onclick = function() {
            var newConfig = tableStream.config;
            newConfig.start_key = null;
            newConfig.end_key = null;
            newConfig.start_item_number = -1 * table_rows;
            newConfig.count = table_rows;
            tableStream.updateStream(newConfig);
            
        };

        sortButton.onclick = function() {
            sortMultiplier=sortMultiplier*(-1);
            renderTable();
        };

        var tableStream = new Stream(socket, startStreamConfig, onNewMessage);
        tableStream.startStream();

    });
</script>